<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω Backup Database</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container my-4">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h1 class="h3 mb-0">C√¥ng c·ª• Backup v√† Upload Database</h1>
                <div id="auth-section">
                    <div id="logged-out" class="d-none">
                        <a href="/login" class="btn btn-sm btn-light">
                            <i class="bi bi-box-arrow-in-right"></i> ƒêƒÉng nh·∫≠p
                        </a>
                    </div>
                    <div id="logged-in" class="d-none">
                        <div class="dropdown">
                            <button class="btn btn-sm btn-light dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-person-circle"></i> <span id="username-display"></span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                                <li><a class="dropdown-item" href="#" id="logout-btn"><i class="bi bi-box-arrow-right"></i> ƒêƒÉng xu·∫•t</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body">
                {{if .NeedAuth}}
                <div class="alert alert-warning">
                    <strong>C·∫ßn x√°c th·ª±c!</strong> ƒê·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng upload l√™n Google Drive, b·∫°n c·∫ßn x√°c th·ª±c t√†i kho·∫£n Google.
                    <div class="mt-2">
                        <button onclick="openAuthWindow()" class="btn btn-primary">
                            <i class="bi bi-google"></i> X√°c th·ª±c v·ªõi Google
                        </button>
                    </div>
                </div>
                {{end}}

                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0">Dump Database</h5>
                            </div>
                            <div class="card-body">
                                <p>T·∫°o b·∫£n sao l∆∞u d·ªØ li·ªáu t·ª´ container Docker v√† l∆∞u v√†o th∆∞ m·ª•c local.</p>
                                <form action="/dump" method="POST" class="auth-required-form">
                                    <button type="submit" class="btn btn-primary">Dump Database</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">Upload l√™n Google Drive</h5>
                            </div>
                            <div class="card-body">
                                <p>Upload file backup m·ªõi nh·∫•t ho·∫∑c t·∫•t c·∫£ c√°c file backup l√™n Google Drive.</p>
                                <div class="d-flex gap-2">
                                    <form action="/upload-last" method="POST" class="auth-required-form">
                                        <button type="submit" class="btn btn-success" {{if .NeedAuth}}disabled{{end}}>Upload File M·ªõi Nh·∫•t</button>
                                    </form>
                                    <form action="/upload-all" method="POST" class="auth-required-form">
                                        <button type="submit" class="btn btn-outline-success" {{if .NeedAuth}}disabled{{end}}>Upload T·∫•t C·∫£</button>
                                    </form>
                                </div>
                                {{if .NeedAuth}}
                                <div class="mt-2 text-danger small">
                                    <i class="bi bi-exclamation-triangle"></i> Vui l√≤ng x√°c th·ª±c t√†i kho·∫£n Google tr∆∞·ªõc khi upload
                                </div>
                                {{end}}
                            </div>
                        </div>
                    </div>
                </div>
                
                {{if not .NeedAuth}}
                <div class="card mb-4">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">Danh s√°ch file backup</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>T√™n file</th>
                                        <th>Ng√†y t·∫°o</th>
                                        <th>K√≠ch th∆∞·ªõc</th>
                                        <th>ƒê√£ upload</th>
                                        <th>Thao t√°c</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {{range .Backups}}
                                    <tr>
                                        <td>{{.Name}}</td>
                                        <td>{{.CreatedAt}}</td>
                                        <td>{{.Size}}</td>
                                        <td>
                                            {{if .Uploaded}}
                                            <span class="badge bg-success">ƒê√£ upload</span>
                                            {{else}}
                                            <span class="badge bg-warning">Ch∆∞a upload</span>
                                            {{end}}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <a href="/download/{{.ID}}" class="btn btn-outline-primary auth-required-btn">T·∫£i xu·ªëng</a>
                                                {{if not .Uploaded}}
                                                <form action="/upload/{{.ID}}" method="POST" class="auth-required-form">
                                                    <button type="submit" class="btn btn-outline-success">Upload</button>
                                                </form>
                                                {{end}}
                                            </div>
                                        </td>
                                    </tr>
                                    {{else}}
                                    <tr>
                                        <td colspan="5" class="text-center py-3">Ch∆∞a c√≥ file backup n√†o</td>
                                    </tr>
                                    {{end}}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {{end}}
                
                {{if .LastOperation}}
                <div class="alert alert-{{if .LastOperation.Success}}success{{else}}danger{{end}} alert-dismissible fade show" role="alert">
                    <strong>{{if .LastOperation.Success}}Th√†nh c√¥ng!{{else}}L·ªói!{{end}}</strong> {{.LastOperation.Message}}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {{end}}
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/script.js"></script>
    <script>
        // Ki·ªÉm tra t√¨nh tr·∫°ng ƒëƒÉng nh·∫≠p khi t·∫£i trang
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, checking login status');
            console.log('Current cookies:', document.cookie);
            console.log('localStorage.auth_token:', localStorage.getItem('auth_token'));
            
            // Ki·ªÉm tra ƒëƒÉng nh·∫≠p ngay khi trang t·∫£i
            if (!isUserLoggedIn()) {
                console.log('‚ùå User not logged in, redirecting to login page');
                window.location.href = '/login';
                return;
            }
            
            // N·∫øu ƒë√£ ƒëƒÉng nh·∫≠p, ti·∫øp t·ª•c kh·ªüi t·∫°o trang
            console.log('‚úÖ User is logged in, initializing page');
            setupUI();
            setupAuthForms();
            
            // Ki·ªÉm tra ƒë·ªãnh k·ª≥ tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
            startLoginCheck();
        });
        
        // Ki·ªÉm tra xem ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p ch∆∞a
        function isUserLoggedIn() {
            // Ki·ªÉm tra nhi·ªÅu ngu·ªìn x√°c th·ª±c
            const localToken = localStorage.getItem('auth_token');
            const loginCookie = getCookie('logged_in');
            const authTokenCookie = getCookie('auth_token');
            
            console.log('Auth check: localStorage token=', !!localToken, 
                       ', logged_in cookie=', loginCookie, 
                       ', auth_token cookie=', !!authTokenCookie);
            
            // N·∫øu c√≥ b·∫•t k·ª≥ ph∆∞∆°ng th·ª©c x√°c th·ª±c n√†o, coi nh∆∞ ƒë√£ ƒëƒÉng nh·∫≠p
            const isLoggedIn = !!localToken || loginCookie === 'true' || !!authTokenCookie;
            console.log('Logged in status:', isLoggedIn);
            
            // N·∫øu c√≥ tr·∫°ng th√°i tr√°i ng∆∞·ª£c nhau, ƒë·ªìng b·ªô l·∫°i
            if (isLoggedIn) {
                // N·∫øu ƒë√£ ƒëƒÉng nh·∫≠p nh∆∞ng thi·∫øu cookie, th·ª≠ ƒë·∫∑t l·∫°i cookie
                if (loginCookie !== 'true' && localToken) {
                    console.log('Missing logged_in cookie but has token, setting cookie');
                    document.cookie = "logged_in=true; path=/; max-age=" + (3600*24*30);
                }
                
                // N·∫øu kh√¥ng c√≥ token trong localStorage nh∆∞ng c√≥ auth_token cookie
                if (!localToken && authTokenCookie) {
                    console.log('Missing localStorage token but has auth_token cookie');
                    // Kh√¥ng th·ªÉ l·∫•y token t·ª´ httpOnly cookie, nh∆∞ng v·∫´n ƒë√°nh d·∫•u l√† ƒë√£ ƒëƒÉng nh·∫≠p
                }
            }
            
            return isLoggedIn;
        }
        
        // Thi·∫øt l·∫≠p giao di·ªán ng∆∞·ªùi d√πng d·ª±a tr√™n tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
        function setupUI() {
            const token = localStorage.getItem('auth_token');
            const userSection = document.getElementById('logged-in');
            const loginSection = document.getElementById('logged-out');
            
            if (token) {
                try {
                    // ƒê·∫£m b·∫£o user data h·ª£p l·ªá
                    const userData = localStorage.getItem('user');
                    const user = userData ? JSON.parse(userData) : null;
                    
                    if (!user || !user.username) {
                        throw new Error('Invalid user data');
                    }
                    
                    // Hi·ªÉn th·ªã ph·∫ßn ƒë√£ ƒëƒÉng nh·∫≠p
                    userSection.classList.remove('d-none');
                    loginSection.classList.add('d-none');
                    
                    // Hi·ªÉn th·ªã t√™n ng∆∞·ªùi d√πng
                    document.getElementById('username-display').textContent = user.username;
                    
                    // B·∫≠t c√°c ph·∫ßn t·ª≠ y√™u c·∫ßu x√°c th·ª±c
                    enableAuthRequiredElements();
                    
                } catch (error) {
                    console.error('Error processing user data:', error);
                    userSection.classList.add('d-none');
                    loginSection.classList.remove('d-none');
                    disableAuthRequiredElements();
                }
            } else {
                userSection.classList.add('d-none');
                loginSection.classList.remove('d-none');
                disableAuthRequiredElements();
            }
        }
        
        // B·∫Øt ƒë·∫ßu ki·ªÉm tra ƒë·ªãnh k·ª≥ tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
        function startLoginCheck() {
            let checkCount = 0;
            
            // Ki·ªÉm tra cookie theo ƒë·ªãnh k·ª≥
            setInterval(function() {
                // Ki·ªÉm tra t·∫•t c·∫£ c√°c ngu·ªìn x√°c th·ª±c
                const localToken = localStorage.getItem('auth_token');
                const loginCookie = getCookie('logged_in');
                const authTokenCookie = getCookie('auth_token');
                
                // ƒê·ªÉ gi·∫£m log, ch·ªâ log ƒë·ªãnh k·ª≥
                checkCount++;
                if (checkCount % 10 === 0) {
                    console.log('üìä Auth status - LocalStorage:', !!localToken, 
                               'Cookie logged_in:', loginCookie, 
                               'Cookie auth_token:', !!authTokenCookie);
                }
                
                // Ki·ªÉm tra s·ª± m·∫•t ƒë·ªìng b·ªô gi·ªØa c√°c ph∆∞∆°ng th·ª©c x√°c th·ª±c
                const hasSomeAuth = !!localToken || loginCookie === 'true' || !!authTokenCookie;
                
                // N·∫øu kh√¥ng c√≥ b·∫•t k·ª≥ ph∆∞∆°ng th·ª©c x√°c th·ª±c n√†o c√≤n l·∫°i, h√£y ƒëƒÉng xu·∫•t
                if (!hasSomeAuth && checkCount > 5) { // B·ªè qua v√†i l·∫ßn ki·ªÉm tra ƒë·∫ßu ti√™n ƒë·ªÉ tr√°nh race condition
                    console.log('‚ö†Ô∏è Kh√¥ng c√≤n ph∆∞∆°ng th·ª©c x√°c th·ª±c n√†o, ƒëƒÉng xu·∫•t');
                    // ƒê·∫£m b·∫£o x√≥a m·ªçi d·∫•u v·∫øt ƒëƒÉng nh·∫≠p
                    localStorage.removeItem('auth_token');
                    localStorage.removeItem('user');
                    document.cookie = "logged_in=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT";
                    document.cookie = "auth_token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT";
                    
                    // Reload ƒë·ªÉ tr√°nh l·ªói redirect loop
                    window.location.reload();
                    return;
                }
                
                // N·∫øu c√≥ m·ªôt s·ªë x√°c th·ª±c nh∆∞ng kh√¥ng nh·∫•t qu√°n, th·ª≠ kh√¥i ph·ª•c
                if (hasSomeAuth) {
                    // N·∫øu c√≥ token nh∆∞ng kh√¥ng c√≥ cookie logged_in, th·ª≠ ƒë·∫∑t l·∫°i cookie
                    if (loginCookie !== 'true' && (localToken || authTokenCookie)) {
                        console.log('üîÑ Kh√¥i ph·ª•c cookie logged_in');
                        document.cookie = "logged_in=true; path=/; max-age=" + (3600*24*30);
                    }
                    
                    // N·∫øu c√≥ cookie auth nh∆∞ng kh√¥ng c√≥ localStorage, th·ª≠ kh√¥i ph·ª•c t·ª´ cookie
                    if (!localToken && (loginCookie === 'true' || authTokenCookie)) {
                        // Kh√¥ng th·ªÉ truy c·∫≠p gi√° tr·ªã t·ª´ httpOnly cookie, 
                        // nh∆∞ng c√≥ th·ªÉ y√™u c·∫ßu t·ª´ server th√¥ng qua API n·∫øu c·∫ßn
                        console.log('‚ö†Ô∏è Thi·∫øu token trong localStorage nh∆∞ng c√≥ cookie x√°c th·ª±c');
                    }
                }
            }, 30000); // Ki·ªÉm tra m·ªói 30 gi√¢y
        }
        
        // L·∫•y gi√° tr·ªã cookie theo t√™n
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }
        
        // Thi·∫øt l·∫≠p s·ª± ki·ªán ƒëƒÉng xu·∫•t
        document.getElementById('logout-btn').addEventListener('click', async function(e) {
            e.preventDefault();
            
            try {
                // G·ªçi API ƒëƒÉng xu·∫•t
                const response = await fetch('/logout', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('auth_token')
                    }
                });
                
                if (response.ok) {
                    // X√≥a token v√† th√¥ng tin ng∆∞·ªùi d√πng t·ª´ localStorage
                    localStorage.removeItem('auth_token');
                    localStorage.removeItem('user');
                    
                    // C·∫≠p nh·∫≠t giao di·ªán
                    setupUI();
                    
                    // Chuy·ªÉn h∆∞·ªõng v·ªÅ trang ƒëƒÉng nh·∫≠p
                    window.location.href = '/login';
                } else {
                    console.error('ƒêƒÉng xu·∫•t th·∫•t b·∫°i');
                }
            } catch (error) {
                console.error('L·ªói khi ƒëƒÉng xu·∫•t:', error);
            }
        });
        
        // Thi·∫øt l·∫≠p s·ª± ki·ªán cho c√°c form y√™u c·∫ßu x√°c th·ª±c
        function setupAuthForms() {
            document.querySelectorAll('.auth-required-form').forEach(form => {
                form.addEventListener('submit', function(e) {
                    const token = localStorage.getItem('auth_token');
                    if (!token) {
                        e.preventDefault();
                        alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ th·ª±c hi·ªán thao t√°c n√†y');
                        window.location.href = '/login';
                        return;
                    }
                    
                    // Th√™m header Authorization cho form submit
                    const headerInput = document.createElement('input');
                    headerInput.type = 'hidden';
                    headerInput.name = 'Authorization';
                    headerInput.value = 'Bearer ' + token;
                    form.appendChild(headerInput);
                });
            });
            
            document.querySelectorAll('.auth-required-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    const token = localStorage.getItem('auth_token');
                    if (!token) {
                        e.preventDefault();
                        alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ th·ª±c hi·ªán thao t√°c n√†y');
                        window.location.href = '/login';
                        return;
                    }
                    
                    // Th√™m token v√†o URL
                    const originalHref = btn.getAttribute('href');
                    const separator = originalHref.includes('?') ? '&' : '?';
                    btn.setAttribute('href', originalHref + separator + 'token=' + token);
                });
            });
        }
        
        // B·∫≠t c√°c ph·∫ßn t·ª≠ y√™u c·∫ßu x√°c th·ª±c
        function enableAuthRequiredElements() {
            document.querySelectorAll('.auth-required-form button').forEach(btn => {
                btn.disabled = false;
            });
        }
        
        // T·∫Øt c√°c ph·∫ßn t·ª≠ y√™u c·∫ßu x√°c th·ª±c
        function disableAuthRequiredElements() {
            document.querySelectorAll('.auth-required-form button').forEach(btn => {
                btn.disabled = true;
            });
        }
        
        function openAuthWindow() {
            // M·ªü c·ª≠a s·ªï m·ªõi ƒë·ªÉ x√°c th·ª±c Google
            const authWindow = window.open("/auth", "GoogleAuth", 
                "width=600,height=700,menubar=no,toolbar=no,location=no,status=no");
            
            // Theo d√µi c·ª≠a s·ªï x√°c th·ª±c
            const checkWindow = setInterval(function() {
                if (authWindow.closed) {
                    clearInterval(checkWindow);
                    // L√†m m·ªõi trang sau khi c·ª≠a s·ªï ƒë√≥ng ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i
                    window.location.reload();
                }
            }, 500);
        }
    </script>
</body>
</html> 