<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÄÄƒng nháº­p | Backup Database</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .login-form {
            max-width: 400px;
            width: 90%;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            background-color: #fff;
        }
        .login-form h1 {
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
        }
        .login-form .logo {
            text-align: center;
            margin-bottom: 20px;
        }
        .login-form .logo i {
            font-size: 48px;
            color: #0d6efd;
        }
    </style>
</head>
<body>
    <div class="login-form">
        <div class="logo">
            <i class="bi bi-database-fill-lock"></i>
        </div>
        <h1>ÄÄƒng nháº­p</h1>
        <div id="login-error" class="alert alert-danger d-none" role="alert"></div>
        <form id="login-form">
            <div class="mb-3">
                <label for="username" class="form-label">TÃªn Ä‘Äƒng nháº­p</label>
                <input type="text" class="form-control" id="username" name="username" required>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">Máº­t kháº©u</label>
                <input type="password" class="form-control" id="password" name="password" required>
            </div>
            <div class="d-grid">
                <button type="submit" class="btn btn-primary btn-block">ÄÄƒng nháº­p</button>
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // HÃ m Ä‘á»ƒ Ä‘á»c cookie
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }
        
        $(document).ready(function() {
            // Kiá»ƒm tra náº¿u ngÆ°á»i dÃ¹ng Ä‘Ã£ Ä‘Äƒng nháº­p, chuyá»ƒn hÆ°á»›ng vá» trang chá»§
            const token = localStorage.getItem('auth_token');
            const loginCookie = getCookie('logged_in');
            
            console.log('ğŸ” Kiá»ƒm tra tráº¡ng thÃ¡i Ä‘Äƒng nháº­p - token:', !!token, 'cookie:', loginCookie);
            
            if (token && loginCookie === 'true') {
                console.log('ğŸ‘¤ NgÆ°á»i dÃ¹ng Ä‘Ã£ Ä‘Äƒng nháº­p, chuyá»ƒn hÆ°á»›ng vá» trang chá»§');
                window.location.href = '/';
                return;
            }
            
            // Tá»± Ä‘á»™ng focus vÃ o trÆ°á»ng username khi trang táº£i xong
            $('#username').focus();

            $('#login-form').submit(function(event) {
                event.preventDefault();
                
                // Hiá»ƒn thá»‹ tráº¡ng thÃ¡i Ä‘ang xá»­ lÃ½ Ä‘Äƒng nháº­p
                $('#login-error').html('<div class="alert alert-info">Äang Ä‘Äƒng nháº­p...</div>');
                
                // Thu tháº­p dá»¯ liá»‡u Ä‘Äƒng nháº­p
                var loginData = {
                    username: $('#username').val(),
                    password: $('#password').val()
                };
                
                // Gá»­i yÃªu cáº§u Ä‘Äƒng nháº­p
                $.ajax({
                    type: 'POST',
                    url: '/login',
                    contentType: 'application/json',
                    data: JSON.stringify(loginData),
                    success: function(response) {
                        console.log('âœ… ÄÄƒng nháº­p thÃ nh cÃ´ng:', response);
                        
                        // LÆ°u token vÃ o localStorage (BÆ°á»›c 1)
                        try {
                            localStorage.setItem('auth_token', response.token);
                            localStorage.setItem('user', JSON.stringify({
                                username: loginData.username
                            }));
                            console.log('âœ… ÄÃ£ lÆ°u token vÃ o localStorage');
                        } catch (e) {
                            console.error('âš ï¸ KhÃ´ng thá»ƒ lÆ°u vÃ o localStorage:', e);
                            // Tiáº¿p tá»¥c mÃ  khÃ´ng hiá»ƒn thá»‹ thÃ´ng bÃ¡o lá»—i cho ngÆ°á»i dÃ¹ng
                        }
                        
                        // Kiá»ƒm tra cookie (BÆ°á»›c 2)
                        setTimeout(function() {
                            const loginCookie = getCookie('logged_in');
                            const authCookie = getCookie('auth_token');
                            console.log('ğŸª Kiá»ƒm tra cookie sau Ä‘Äƒng nháº­p - logged_in:', loginCookie, 'auth_token:', !!authCookie);
                            
                            // Náº¿u cookie khÃ´ng Ä‘Æ°á»£c Ä‘áº·t, thá»­ Ä‘áº·t láº¡i
                            if (loginCookie !== 'true') {
                                console.log('âš ï¸ Cookie logged_in khÃ´ng Ä‘Æ°á»£c tÃ¬m tháº¥y, Ä‘áº·t láº¡i');
                                document.cookie = "logged_in=true; path=/; max-age=" + (3600*24*30);
                                
                                // Kiá»ƒm tra láº¡i sau khi Ä‘áº·t
                                setTimeout(function() {
                                    const recheckedCookie = getCookie('logged_in');
                                    console.log('ğŸ”„ Kiá»ƒm tra láº¡i cookie - logged_in:', recheckedCookie);
                                    redirectToHome();
                                }, 100);
                            } else {
                                redirectToHome();
                            }
                        }, 300); // Äá»£i 300ms Ä‘á»ƒ Ä‘áº£m báº£o cookie Ä‘Æ°á»£c lÆ°u
                    },
                    error: function(xhr) {
                        // Hiá»‡n thÃ´ng bÃ¡o lá»—i Ä‘Äƒng nháº­p
                        console.error('âŒ Lá»—i Ä‘Äƒng nháº­p:', xhr.responseJSON);
                        
                        let message = 'ÄÄƒng nháº­p tháº¥t báº¡i';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            message = xhr.responseJSON.message;
                        }
                        
                        $('#login-error').html('<div class="alert alert-danger">' + message + '</div>');
                    }
                });
            });
            
            // Chuyá»ƒn hÆ°á»›ng vá» trang chá»§
            function redirectToHome() {
                console.log('ğŸ  Chuyá»ƒn hÆ°á»›ng vá» trang chá»§');
                $('#login-error').html('<div class="alert alert-success">ÄÄƒng nháº­p thÃ nh cÃ´ng! Äang chuyá»ƒn hÆ°á»›ng...</div>');
                window.location.href = '/';
            }
        });
    </script>
</body>
</html> 